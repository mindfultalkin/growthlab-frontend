<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Activity</title>
    <style>
       /* General body styling */
body {
    background: linear-gradient(#CAF3BC, #ffff);
    background-repeat: no-repeat;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    color: #333;
    text-align: center;
}

/* Styling for the heading */
h1 {
    margin-top: 80px;
    font-size: 2.2em;
    color: #2C3E50;
    font-weight: bold;
    padding: 0 10px;
}

/* Content area container */
#contentArea {
    margin: 30px auto;
    padding: 20px;
    width: 90%;
    max-width: 800px;
    background-color: #ffffff;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    overflow-y: auto;
    max-height: 80vh;
}

/* Button container styling */
.buttons {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
}

/* Button styling */
button {
    padding: 10px 15px;
    margin: 10px;
    background-color: #00A66B;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 1.1em;
    cursor: pointer;
    transition: background-color 0.3s ease;
    flex-grow: 1;
    max-width: 200px;
}

button:hover {
    background-color: #2980B9;
}

/* Audio and video player styling */
audio, video {
    width: 100%;
    max-width: 100%;
    border-radius: 10px;
    margin-top: 20px;
    background-color: #F0F0F0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Image content styling */
img {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    margin-top: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* PDF iframe styling */
iframe {
    width: 100%;
    height: 500px;
    border: none;
    border-radius: 10px;
    margin-top: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* Paragraph styling for unsupported content type */
p {
    color: #00A66B;
    font-size: clamp(20px, 1vw, 7vw); /* Minimum: 1rem, Preferred: 4vw, Maximum: 2.5rem */
    font-weight: bold;
    margin-top: 20px;
}

/* Button focus styling */
button:focus {
    outline: none;
    box-shadow: 0 0 5px rgba(52, 152, 219, 0.8);
}

/* Responsive styles for mobile devices */
@media screen and (max-width: 768px) {
    h1 {
        font-size: 1.8em;
        margin-top: 50px;
    }

    #contentArea {
        padding: 15px;
    }

    button {
        padding: 10px 12px;
        font-size: 1em;
        max-width: 100%;
    }

    iframe {
        height: 400px;
    }
}

/* Further adjustments for smaller mobile devices (phones) */
@media screen and (max-width: 480px) {
    h1 {
        font-size: 1.5em;
        margin-top: 30px;
    }

    button {
        font-size: 0.9em;
    }

    iframe {
        height: 350px;
    }
}


        
    </style>
</head>
<body >
    <h1 style="margin-top: 100px;">Complete the activity</h1>

    <div id="contentArea">
        <!-- Dynamic content will be loaded here based on subconcept type -->
    </div>

    <div class="buttons">
        <button id="completeBtn">Complete</button>
        <button id="backBtn">Go Back to Activities</button>
    </div>

    <script>
        // Listen for the postMessage from the parent window
        window.addEventListener("message", function(event) {
            const subconcept = event.data;
            console.log(subconcept)
            // Render content dynamically based on subconcept type
            renderContent(subconcept);

            // Set up event listeners for buttons after content is rendered
            setupEventListeners(subconcept);
        });

        // Function to render content dynamically
        function renderContent(subconceptData) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = ''; // Clear any previous content

            const type = subconceptData.subconceptType; // e.g., 'audio', 'video', 'pdf', 'image'
            const url = subconceptData.subconceptLink; // URL of the content

            let contentElement;

            switch (type) {
                case 'audio':
                    contentElement = document.createElement('audio');
                    contentElement.controls = true;
                    contentElement.innerHTML = `<source src="${url}" type="audio/mp3"> Your browser does not support the audio element.`;
                    break;
                case 'video':
                    contentElement = document.createElement('video');
                    contentElement.controls = true;
                    contentElement.innerHTML = `<source src="${url}" type="video/mp4"> Your browser does not support the video element.`;
                    break;
                case 'image':
                    contentElement = document.createElement('img');
                    contentElement.src = url;
                    contentElement.alt = "Image content";
                    contentElement.style.maxWidth = "100%";
                    break;
                case 'pdf':
                    contentElement = document.createElement('iframe');
                    contentElement.src = url;
                    contentElement.width = "100%";
                    contentElement.height = "500px";
                    contentElement.title = "PDF Document";
                    break;
                default:
                    contentElement = document.createElement('p');
                    contentElement.textContent = "Activity complete. Your data has been submitted successfully!";
                    break;
            }

            // Append the dynamically created element to the content area
            contentArea.appendChild(contentElement);
        }

        // Function to set up event listeners for buttons
        function setupEventListeners(subconceptData) {
            const completeBtn = document.getElementById('completeBtn');
            const backBtn = document.getElementById('backBtn');
            let PlayedPercentage = 0;

            const contentType = subconceptData.subconceptType;
            const contentElement = document.querySelector(contentType === 'audio' ? 'audio' : 'video');

            if (contentType === 'audio' || contentType === 'video') {
                // Track how much the media was played
                contentElement.addEventListener('timeupdate', () => {
                    const playedTime = contentElement.currentTime;
                    const totalTime = contentElement.duration;
                    PlayedPercentage = (playedTime / totalTime) * 100;
                });
            }

            // Handle "Complete" button click
            completeBtn.addEventListener('click', () => {
                completeBtn.disabled = true;
                completeBtn.style.backgroundColor = 'gray';
                completeBtn.style.cursor = "not-allowed";
                if (contentType === 'audio' || contentType === 'video') {
                    console.log("Played percentage:", PlayedPercentage);
                    contentElement.pause();
                }

                window.parent.postMessage("requestUserData", "*");

                window.addEventListener(
                    "message",
                    function (event) {
                        let userData;
                        try {
                            userData = JSON.parse(event.data);

                            if (!userData) {
                                console.error("No userData received or userData is empty.");
                                return;
                            }

                            console.log("Received userData:", userData);

                            // Calculate the final score
                            let finalScore = (PlayedPercentage >= 80)
                                ? 10 // change to userData.subconceptMaxscore
                                : 0;

                            const payload = {
                                userAttemptFlag: true,
                                userAttemptScore: finalScore,
                                userAttemptStartTimestamp: userData.userAttemptStartTimestamp,
                                userAttemptEndTimestamp: new Date().toISOString(),
                                unit: { unitId: userData.unitId },
                                program: { programId: userData.programId },
                                stage: { stageId: userData.stageId },
                                user: { userId: userData.userId },
                                session: { sessionId: userData.sessionId },
                                subconcept: { subconceptId: userData.subconceptId },
                            };

                            console.log(payload);

                            // Send the data to the server
                            fetch(`${userData.API_BASE_URL}/user-attempts`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(payload),
                            })
                                .then((response) => {
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! Status: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then((data) => {
                                    console.log("Data sent successfully", data);
                                })
                                .catch((error) => {
                                    console.error("Error:", error);
                                });

                        } catch (e) {
                            console.error("Error parsing userData:", e);
                        }
                    },
                    { once: true }
                );
            });

            // Handle "Go Back to Activities" button click
            backBtn.addEventListener('click', () => {
                window.history.back();
            });
        }
    </script>
</body>
</html>
